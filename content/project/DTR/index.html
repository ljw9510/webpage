---
title: "Review of 'Q- and A-learning Methods for Estimating Optimal Dynamic Treatment Regimes'"
subtitle: Phillip J. Schulte, Anastasios A. Tsiatis, Eric B. Laber, and Marie Davidian
author: "Joowon Lee"
date: "2022-10-24"
categories: ["Causal Inference"]
tags: ["Causal Inference", "Dynamic Treatment Regime"]
excerpt: Review of the paper "Q- and A-learning Methods for Estimating Optimal Dynamic Treatment Regimes" written by P. J. Schulte, et al., (2014).
links:
- icon: door-open
  icon_pack: fas
  name: paper
  url: https://pubmed.ncbi.nlm.nih.gov/25620840/
---



<hr />
<div id="list" class="section level3">
<h3>List</h3>
<p><a href="#overview">1. Overview</a></p>
<p><a href="#identification">2. Identification</a></p>
<hr />
</div>
<div id="overview" class="section level3">
<h3>Overview</h3>
<p>In this project, we will review a paper <em>Q- and A-learning Methods for Estimating Optimal Dynamic Treatment Regimes</em> written by Phillip J. Schulte et al., (2014) <a href="https://pubmed.ncbi.nlm.nih.gov/25620840/">[paper]</a>.</p>
<p>In clinical practice, clinicians make a series of decisions based on individual patient’s baseline and evolving characteristics. In this paper, we wanted to make optimal sequential treatment decisions to achieve the ‘best’ outcome for an individual patient. The list of sequential decision rules is formalized as a dynamic treatment regime. Throughout this paper, we investigate two main methods, Q-learning and A-learning, to estimate the optimal dynamic treatment regime based on data from a clinical trial or observational study.</p>
<p>Let us first introduce the following notations:</p>
<blockquote>
<ul>
<li><span class="math inline">\(k\)</span> : stages or pre-specified ordered decision points <span class="math inline">\(k = 1, \cdots, K\)</span>,</li>
<li><span class="math inline">\(\Omega\)</span> : a superpopulation of patients with a patient <span class="math inline">\(\omega \in \Omega\)</span>,</li>
<li><span class="math inline">\(Y\)</span> : a final outcome of interest (assuming that large values are preferred),</li>
<li><span class="math inline">\(X_{k}\)</span> : covariate information immediately prior to decision <span class="math inline">\(k\)</span> with value <span class="math inline">\(x_{k} \in \mathcal{X}_{k}\)</span>,</li>
<li><span class="math inline">\(A_{k}\)</span> : treatment at stage <span class="math inline">\(k\)</span> with value <span class="math inline">\(a_{k} \in \mathcal{A}_{k}\)</span> (a finite set possible options)</li>
<li><span class="math inline">\(\overline{a_{k}} = (a_{1}, \cdots, a_{k})\)</span> : a possible treatment history through decision <span class="math inline">\(k\)</span> taking values in <span class="math inline">\(\overline{\mathcal{A}_{k}} = \mathcal{A}_{1} \times \cdots \mathcal{A}_{k}\)</span>.</li>
</ul>
</blockquote>
<blockquote>
<p>Then we define the <strong>potential outcomes</strong>
<span class="math display">\[\begin{align*}
W^{*} &amp;= \left\{ X^{*}_{2}(a_{1}), X^{*}_{3}\big(\overline{a_{2}}\big), \cdots, X^{*}_{K}\big(\overline{a_{k-1}}\big), Y^{*}\big(\overline{a_{k}}\big) \,\, \text{ for all } \, \overline{a_{k}} \in \overline{\mathcal{A}_{k}} \right\}
\end{align*}\]</span></p>
</blockquote>
<p>Here, <span class="math inline">\(X^{*}_{K}\big(\overline{a_{k-1}}\big)(\omega)\)</span> denotes the value of covariate information that would arise between decisions <span class="math inline">\(k-1\)</span> and <span class="math inline">\(k\)</span> for a patient <span class="math inline">\(\omega \in \Omega\)</span> who have received treatment history <span class="math inline">\(\overline{a_{k-1}}\)</span>, taking value <span class="math inline">\(x_{k}\)</span> in a set <span class="math inline">\(\mathcal{X}_{k}\)</span>. Similarly, <span class="math inline">\(Y^{*}\big(\overline{a_{k}}\big)\)</span> is the hypothetical outcome that would result for a patient <span class="math inline">\(\omega\)</span> who have received the full set of <span class="math inline">\(K\)</span> treatment in <span class="math inline">\(\overline{a_{k}}\)</span>. For simplicity, we write <span class="math inline">\(\overline{X}^{*}_{\underline{k}}\big(\overline{a_{k-1}}\big)=\{X_{1}, X^{*}_{2}(a_{1}), \cdots, X^{*}_{K}\big(\overline{a_{k-1}}\big)\}, k = 1, \cdots, K\)</span>.</p>
<hr />
</div>
<div id="dynamic-treatment-regime" class="section level3">
<h3>Dynamic Treatment Regime</h3>
<p>A dynamic treatment regime <span class="math inline">\(\mathbf{d} = (d_{1}, \cdots, d_{K})\)</span> is a set of rules that forms an algorithm to treat individual patient over time (it is called ‘<em>dynamic</em>’ because treatment is determined based on a patient’s previous history). For example, at the <span class="math inline">\(k\)</span>th stage,</p>
<ul>
<li>the <span class="math inline">\(k\)</span>th rule <span class="math inline">\(d_{k}\)</span> takes
<ul>
<li>input : <span class="math inline">\(\overline{x_{k}}, \overline{a_{k-1}}\)</span> (patient’s realized covariate, and treatment history up to <span class="math inline">\(k-1\)</span>th decision),</li>
<li>output : <span class="math inline">\(a_{k} \in \Psi_{k}(\overline{x_{k}}, \overline{a_{k-1}}) \subset \mathcal{A}_{k}\)</span> where <span class="math inline">\(\Psi_{k}(\overline{x_{k}}, \overline{a_{k-1}})\)</span> is a pre-specified set of possible traetment options for a patient with (<span class="math inline">\(\overline{x_{k}}, \overline{a_{k-1}}\)</span>).</li>
</ul></li>
</ul>
<p>Since <span class="math inline">\(d_{k}\)</span> need only map a subset of <span class="math inline">\(\overline{\mathcal{X}_{k}} \times \overline{\mathcal{A}_{k-1}}\)</span>, namely <span class="math inline">\(\Gamma_{k}\)</span>, to <span class="math inline">\(\mathcal{A}_{k}\)</span>, let us define the subset <strong>recursively</strong> as</p>
<p><span class="math display">\[\begin{align*}
\Gamma_{k} &amp;= \{ (\overline{x_{k}}, \overline{a_{k-1}}) \in \overline{\mathcal{X}_{k}} \times \overline{\mathcal{A}_{k-1}} \,\, \text{ satisfying } \\
&amp; \quad \quad \text{(i) } \, a_{j} \in \Psi_{j}\big( \overline{x_{j}}, \overline{a_{j-1}} \big), \,\, j = 1, \cdots, k-1, \\
&amp; \quad \quad \text{(ii) } \, \mathbb{P}(\overline{X_{k}}\big(\overline{a_{k-1}} \big)=\overline{x_{k}})&gt;0\},
\end{align*}\]</span></p>
<p><span class="math inline">\(k=1, \cdots, K\)</span>, determined by <span class="math inline">\(\Psi=(\Psi_{1}, \cdots, \Psi_{K})\)</span>. Define the class <span class="math inline">\(\mathcal{D}\)</span> of dynamic treatment regimes to be the set of all <span class="math inline">\(\mathbf{d}=(d_{1}, \cdots. d_{k})\)</span> where <span class="math inline">\(d_{k}: \Gamma_{k} \rightarrow \mathcal{A}_{k}, k=1, \cdots, K\)</span>.</p>
<blockquote>
<p>Then, for any <span class="math inline">\(\mathbf{d} \in \mathcal{D}\)</span>, define the <strong>potential outcomes associated with <span class="math inline">\(\mathbf{d}\)</span></strong> as
<span class="math display">\[\begin{align*}
\left\{ X^{*}_{2}(d_{1}),  \cdots, X^{*}_{k}\big(\overline{d_{k-1}}\big), \cdots,  X^{*}_{K}\big(\overline{d_{k-1}}\big), Y^{*}\big(\mathbf{d}\big) \,\, \right\}
\end{align*}\]</span></p>
</blockquote>
<p>Then how can we find an optimal regime (the ‘best’ treatment for a patient) with these definitions?</p>
<p>The expected outcome in the population with all patients who have a baseline covariate <span class="math inline">\(X_{1} = x_{1}\)</span> and follow regime <span class="math inline">\(\mathbf{d}\)</span> is <span class="math inline">\(\mathbb{E}[Y^{*}\big(\mathbf{d}\big)\ | X_{1} = x_{1}]\)</span>. Then an optimal regime, <span class="math inline">\(\mathbf{d}^{opt} \in \mathcal{D}\)</span>, should satisfies</p>
<p><span class="math display">\[\begin{align*}
&amp; \mathbb{E}[Y^{*}\big(\mathbf{d}\big)\ | X_{1} = x_{1}] \quad \le \quad \mathbb{E}[Y^{*}\big(\mathbf{d}^{opt}\big)\ | X_{1} = x_{1}], \,\, \text{ for all } \mathbf{d} \in \mathcal{D} \text{ and all } x_{1} \in \mathcal{X}_{1} \\
\Rightarrow \,\, &amp; \mathbb{E}[Y^{*}\big(\mathbf{d}\big)] \qquad \qquad \quad \, \le \quad \mathbb{E}[Y^{*}\big(\mathbf{d}^{opt}\big)], \qquad \quad \quad \,\, \text{ for all } \mathbf{d} \in \mathcal{D}
\end{align*}\]</span></p>
<hr />
</div>
<div id="Model_Setup_and_Assumptions" class="section level3">
<h3>Model Setup and Assumptions</h3>
<p>The problem is that potential outcomes for an individual patient for all <span class="math inline">\(\mathbf{d} \in \mathcal{D}\)</span> may not be observed. Therefore, the goal of dynamic treatment regime is to estimate <span class="math inline">\(\mathbf{d}^{opt}\)</span> based on data. Consider a study with a random sample of <span class="math inline">\(n\)</span> patients in <span class="math inline">\(\Omega\)</span>. Assume independent and identically distributed time-ordered random variables <span class="math inline">\((X_{1i}, A_{1i}, \cdots, X_{Ki}, A_{Ki}, Y_{i}), i = 1, \cdots, n\)</span>.</p>
<p>Use causal framework to estimate an optimal regime from the observed data under the following assumptions:</p>
<ul>
<li>Consistency assumption : <span class="math inline">\(X_{k} = X^{*}_{k}\big(\overline{A_{k-1}}\big), k=2, \cdots, K\)</span> and <span class="math inline">\(Y=Y^{*}\big(\overline{A_{k}}\big)\)</span>,</li>
<li>Stable unit treatment value assumption (well-defineness) : a patient’s covariates and outcome are not affected by treatment assignment and other patients,</li>
<li>Sequential Ignorability : <span class="math inline">\(A_{k} \perp W^{*} | \{\overline{X_{k}}, \overline{A_{k-1}} \}, k=1, \cdots, K\)</span>.</li>
</ul>
<hr />
</div>
<div id="identification" class="section level3">
<h3>Identification</h3>
<p>In this section, we are interested in identifying the expected potential outcome <span class="math inline">\(\mathbb{E}[Y^{*}(\overline{a_{K}})]\)</span> which may or may not be observable based on statistical quantity.</p>
<p>We first consider a fixed treatment <span class="math inline">\((a_{1}, a_{2}) \in \{0, 1\}^{2}\)</span> with the two time points <span class="math inline">\((k = 2)\)</span>. We have time-ordered variables <span class="math inline">\((X_{1}, A_{1}, X_{2}, A_{2}, Y)\)</span>, where the dependency between them can be described as the following dynamic acyclic graph (DAG):</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:dag"></span>
<img src="figures/dag.png" alt="Dynamic acyclic graph for k = 2" width="50%" />
<p class="caption">
Figure 1: Dynamic acyclic graph for k = 2
</p>
</div>
<p>From the following lemma below, we show that the expected potential outcome <span class="math inline">\(\mathbb{E}[Y^{*}(\overline{a_{2}})]=\mathbb{E}[Y^{*}(a_{1}, a_{2})]\)</span> of treatment <span class="math inline">\((a_{1}, a_{2})\)</span> can be identified as a statistical estimand, a function of conditional expectation.</p>
<p><br />
</p>
<div class="lemma">
<p><span id="lem:unlabeled-div-1" class="lemma"><strong>Lemma 1  </strong></span><em>Fix a treatment <span class="math inline">\((a_{1},a_{2})\in \{0,1\}^{2}\)</span>. Under the assumptions of consistency, SUTVA, and sequential ignorability mentioned in the section <a href="#Model_Setup_and_Assumptions">Model setup and assumptions</a>, we have</em>
<span class="math display">\[\begin{align*}
&amp;\mathbb{E}[Y^{*}(a_1, a_2)] \\
&amp; \quad = \mathbb{E}_{X_{1}} \bigg[ \mathbb{E}_{X_{2}} \bigg[ \mathbb{E}_{Y}[Y | X_{1}, A_{1} = a_{1}, X_{2}, A_{2} = a_{2}] \bigg| X_{1}, A_{1} = a_{1} \bigg] \bigg] \\
&amp; \quad = \int_{x_{1}} \int_{x_{2}} \mathbb{E}_{Y}[Y | X_{1}, A_{1} = a_{1}, X_{2}, A_{2} = a_{2}] \,\, \mathbb{P}\left(X_{2}=x_{2}|X_{1}=x_{1}, A_{1} = a_{1} \right) \mathbb{P}\left(X_{1}=x_{1}\right)dx_{2}dx_{1}.
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-2" class="proof"><em>Proof</em>. </span><span class="math inline">\({}\)</span>
Here, let us denote <span class="math inline">\(X^{*}_{2} := X^{*}_{2}(a_{1})\)</span> and <span class="math inline">\(Y^{*} := Y^{*}(a_1, a_2)\)</span>, which we will be using when these random variables are in subscripts for simplicity. Then
<span class="math display">\[\begin{align*}
&amp;\mathbb{E}[Y^{*}(a_1, a_2)] \\
&amp;\quad =\mathbb{E}_{X_{1}} \bigg[ \mathbb{E}_{X^{*}_{2},Y^{*}}[Y^{*}(a_1, a_2) | X_{1}]\bigg] \\
&amp;\quad \overset{(a)}{=}\mathbb{E}_{X_{1}} \bigg[ \mathbb{E}_{X^{*}_{2},Y^{*}}[Y^{*}(a_1, a_2) | X_{1}, A_{1} = a_{1}]\bigg] \\
&amp;\quad \overset{(b)}{=}\mathbb{E}_{X_{1}} \bigg[ \mathbb{E}_{X^{*}_{2}} \bigg[ \mathbb{E}_{Y^{*}}[Y^{*}(a_1, a_2) | X_{1}, A_{1} = a_{1}, X^{*}_{2}(a_{1})] \bigg| X_{1}, A_{1} = a_{1}\bigg] \bigg] \\
&amp;\quad \overset{(c)}{=}\mathbb{E}_{X_{1}} \bigg[ \mathbb{E}_{X^{*}_{2}} \bigg[ \mathbb{E}_{Y^{*}}[Y^{*}(a_1, a_2) | X_{1}, A_{1} = a_{1}, X^{*}_{2}(a_{1}), A_{2} = a_{2}] \bigg| X_{1}, A_{1} = a_{1}\bigg] \bigg]  \\
&amp;\quad \overset{(d)}{=}\mathbb{E}_{X_{1}} \bigg[ \mathbb{E}_{X_{2}} \bigg[ \mathbb{E}_{Y}[Y| X_{1}, A_{1} = a_{1}, X_{2}, A_{2} = a_{2}] \bigg| X_{1}, A_{1} = a_{1}\bigg] \bigg] \\
&amp;\quad =  \int_{x_{1}} \int_{x_{2}} \mathbb{E}[Y | X_{1} = x_{1}, A_{1} = a_{1}, X_{2} = x_{2}, A_{2} = a_{2}] \mathbb{P}\left(X_{2} = x_{2} | X_{1} = x_{1}, A_{1} = a_{1}\right) \mathbb{P}(X_{1} = x_{1}) dx_{2} dx_{1}, \\
\end{align*}\]</span>
where (a) and (c) use sequential ignorability, (b) uses iterated expectation, and (d) use consistency.
<span class="math display">\[\begin{align*}
\hspace{15cm} \square
\end{align*}\]</span></p>
</div>
<p>Now consider the general case when we have <span class="math inline">\(K\)</span> time points. We have time-varying variables <span class="math inline">\((X_{1}, A_{1}, \cdots, X_{K}, A_{K}, Y)\)</span>, assuming all dependencies between variables with proper temporal orders as shown in Figure <a href="#fig:dag">1</a>. Then we introduce the lemma for identification with <span class="math inline">\(K\)</span> time points.</p>
<p><br />
</p>
<div class="lemma">
<p><span id="lem:unlabeled-div-3" class="lemma"><strong>Lemma 2  </strong></span><em>Fix a treatment <span class="math inline">\(\overline{a_{K}}=(a_{1},\cdots,a_{K})\in \{0,1\}^{K}\)</span>. Under the assumptions of consistency, SUTVA, and sequential ignorability, we have</em>
<span class="math display">\[\begin{align*}
&amp;\mathbb{E}[Y^{*}(\overline{a_{K}})] \\
&amp;\quad = \mathbb{E}_{X_{1}} \bigg[ \mathbb{E}_{X_{2}} \bigg[ \cdots
\bigg[ \mathbb{E}_{X_{K}}\left[ \mathbb{E}\left[Y \bigg| \begin{matrix} \overline{X_{K}} \\ \overline{A_{K}} = \overline{a_{K}} \end{matrix}\right]
\bigg| \begin{matrix} \overline{X_{K-1}} \\ \overline{A_{k-1}} = \overline{a_{k-1}} \end{matrix} \right]  
\bigg| \begin{matrix} \overline{X_{K-2}} \\ \overline{A_{k-2}} = \overline{a_{k-2}} \end{matrix} \bigg] \cdots
\bigg| \begin{matrix} X_{1} \\ A_{1} = a_{1} \end{matrix}\bigg] \bigg]
\end{align*}\]</span></p>
</div>
<div class="proof">
<p><span id="unlabeled-div-4" class="proof"><em>Proof</em>. </span><span class="math inline">\({}\)</span></p>
<p>The idea of the proof is to use induction on the number of unobserved treatments. Let us define the following quantities:
<span class="math display">\[\begin{align*}
\mathcal{F}_{k} &amp;: \sigma \text{-algebra generated by information up to } k , \\
\overline{Z_{[k+1,K]}} &amp;= (Z_{k+1}, Z_{k+2}, \cdots, Z_{K}).
\end{align*}\]</span>
We prove the following stronger claim:</p>
<p>For <span class="math inline">\(k \in \{0, 1, \cdots, K \}\)</span>,
<span class="math display">\[\begin{align*}
&amp;\mathbb{E}\left[ Y^{*}(\overline{A_{k}}, \overline{a_{[k+1,K]}}) \bigg|\mathcal{F}_{k}\right]
= \mathbb{E}_{X_{k+1}}\left[ \mathbb{E}_{X_{k+2}}
\left[ \cdots \left[ \mathbb{E}\left[Y \bigg| \begin{matrix} \overline{X_{[k+1, K]}} \\ \overline{A_{[k+1, K]}} = \overline{a_{[k+1,T]}} \\ \mathcal{F}_{k} \end{matrix}\right] \bigg| \right] \cdots \right]
\bigg| \begin{matrix} \overline{X_{k+1}} \\ \overline{A_{k+1}} = \overline{a_{k+1}} \\ \mathcal{F}_{k} \end{matrix}
\right]
\end{align*}\]</span>
Then the statement follows by taking <span class="math inline">\(k=0\)</span>. We use induction on <span class="math inline">\(K-k=\)</span> the number of unobserved treatment.</p>
<p>First, Let <span class="math inline">\(k = K\)</span>. Since we have all information up to K and there is no counterfactual outcome,
<span class="math display">\[\begin{align*}
&amp; \mathbb{E}[Y^{*}(A_{1}, \cdots, A_{K})|\mathcal{F}_{K}]  = \mathbb{E}[Y|\overline{X_{K}}, \overline{A_{K}}, \mathcal{F}_{K}]. \\
\end{align*}\]</span></p>
<p>Next, assume induction hypothesis for <span class="math inline">\(k\)</span> holds. We wish to show induction hypothesis holds for <span class="math inline">\(k-1\)</span>.
<span class="math display">\[\begin{align*}
&amp; \mathbb{E}[Y^{*}(A_{1}, \cdots, A_{k-1}, a_{k}, \cdots, a_{K}) | \mathcal{F}_{k-1}] \\
&amp; \quad \overset{(a)}{=} \mathbb{E}_{X_{k}} \left[ \mathbb{E} \left[ Y^{*}(A_{1}, \cdots, A_{k-1}, a_{k}, \cdots, a_{K}) \bigg| X_{k}, \mathcal{F}_{k-1} \right] \right] \\
&amp; \quad \overset{(b)}{=} \mathbb{E}_{X_{k}} \left[ \mathbb{E} \left[ Y^{*}(A_{1}, \cdots, A_{k-1}, a_{k}, \cdots, a_{K}) \bigg| X_{k}, \overline{A_{k}} = \overline{a_{k}}, \mathcal{F}_{k-1} \right] \right] \\
&amp; \quad = \mathbb{E}_{X_{k}} \left[ \mathbb{E} \left[ Y^{*}(A_{1}, \cdots, A_{k-1}, A_{k}, \cdots, a_{K}) \bigg| X_{k}, \overline{A_{k}} = \overline{a_{k}}, \mathcal{F}_{k-1} \right] \right] \\
&amp; \quad \overset{(c)}{=} \mathbb{E}_{X_{k}} \left[ \mathbb{E} \left[ Y^{*}(A_{1}, \cdots, A_{k-1}, A_{k}, \cdots, a_{K}) \bigg| \mathcal{F}_{k} \right] \right] \\
&amp; \quad = \mathbb{E}_{X_{k}} \left[ \mathbb{E} \left[ Y^{*}(A_{1}, \cdots, A_{k}, a_{k+1}, \cdots, a_{K}) \bigg|  \mathcal{F}_{k} \right] \right] \\
&amp; \quad \overset{(d)}{=} \mathbb{E}_{X_{k}} \left[ \mathbb{E}_{X_{k+1}}\left[ \mathbb{E}_{X_{k+2}}
\left[ \cdots \left[ \mathbb{E}\left[Y \bigg| \begin{matrix} \overline{X_{[k+1, K]}} \\ \overline{A_{[k+1, K]}} = \overline{a_{[k+1,T]}} \\ \mathcal{F}_{k} \end{matrix}\right] \bigg| \right] \cdots \right]
\bigg| \begin{matrix} \overline{X_{k+1}} \\ \overline{A_{k+1}} = \overline{a_{k+1}} \\ \mathcal{F}_{k} \end{matrix}
\right] \right]
\end{align*}\]</span>
where (a) uses iterated expectation, (b) uses sequential ignorability, (c) uses no unmeasured confounder assumption in SUTVA, and (d) is from the assumed induction hypothesis. Since it holds for <span class="math inline">\(k-1\)</span>, we are done.
<span class="math display">\[\begin{align*}
\hspace{12.5cm} \square
\end{align*}\]</span></p>
</div>
</div>
